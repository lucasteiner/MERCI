# MERCI

# Molecular Ensemble Reordering Script for CREST

This Python script is designed to work in conjunction with the **CREST** program, a widely used tool for conformational sampling. 
When using two initial starting structures in a default CREST run, 
the enumeration of the resulting molecular ensembles may differ between the structures. 
This can lead to duplicate structures that need to be identified and removed.

**Problem**:  
When you run CREST with two different initial structures, it generates ensembles of conformers. 
However, the atom enumeration of these conformers may differ, even if the structures are identical. 
Before combining these ensembles, it's crucial to identify and remove any duplicate structures. 
The **cregen** function in CREST can handle this task, but it requires the correct atom sort order. 
Unfortunately, CREST may reorder two initial structures differently, causing challenges when trying to remove duplicates.

**Solution**:  
This script reorders the output ensembles from CREST to ensure they have a consistent atom enumeration. 
It identifies any potential duplicate structures and reorders them based on RMSD (Root Mean Square Deviation) matching. 
The script only reorders structures if duplicates are found. 
If no duplicates exist, no actions are taken, and no further steps are necessary.

By using this script, you ensure that the **cregen** function in CREST can properly detect and remove duplicate structures, making the ensemble combination process easier.

## Features

- **Reorder Molecular Ensembles**: The script takes two sets of molecular structures (ensembles) generated by CREST and reorders them to a consistent atom enumeration.
- **Duplicate Detection**: Only reorders the ensembles if duplicate structures are found. If no duplicates are present, no changes are made.
- **RMSD-based Matching**: Uses centroid sorting, the Kabsch algorithm, and the Hungarian algorithm to reorder the atoms based on RMSD minimization.
- **Command-line Interface**: Easily integrates into CREST workflows via command-line arguments for input and output files.

### Requirements

- Python 3.x
- Required Python libraries:
  - `numpy`
  - `scipy`


### Usage

To use the script, you need to provide three command-line arguments:

    reference_ensemble.xyz: The filename of the ensemble of target structures (in XYZ format).
    target_ensemble.xyz:    The filename of the reference ensemble of structures (in XYZ format).
    reordered_ensemble.xyz: The filename where the reordered ensemble should be saved.

### Command Example
```bash
python reference_ensemble.xyz target_ensemble.xyz reordered_ensemble.xyz
```

### Script Logic

1.) Parse XYZ Files: The script reads the molecular structures from the provided XYZ files.
2.) Moment of Inertia Calculation: For each molecule, moments of inertia are calculated and used as a preliminary filter.
3.) Kabsch and Hungarian Algorithms: The Kabsch algorithm aligns the structures, while the Hungarian algorithm is used for optimal atom reordering based on RMSD minimization.
4.) Reordering: Once a match with an RMSD < 0.1 is found, the atom order is determined and applied to all structures in the target ensemble.
5.) Output: The reordered target ensemble is written to the specified XYZ file.



### XYZ Format

The input and output files must be in XYZ format, where each structure includes:

- The number of atoms on the first line.
- A comment line containing the energy.
- The atom symbols and coordinates for each atom.

```
4
-76.123456
C 0.000000 0.000000 0.000000
O 1.200000 0.000000 0.000000
H -0.800000 0.800000 0.000000
H -0.800000 -0.800000 0.000000
```


